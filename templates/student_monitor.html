<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 모니터링</title>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const video = document.createElement('video');
            video.id = 'videoElement';  // 비디오 ID 추가
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const studentName = "{{ student_name }}";
            const statusElem = document.getElementById('status');
            const loadingElem = document.getElementById('loading');  // 로딩 메시지
            loadingElem.style.display = 'block';  // 로딩 메시지 표시

            // 웹캠 시작
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play().catch(err => {
                        console.error('Error playing video:', err);
                        statusElem.textContent = '비디오 재생 오류';
                    });

                    // 주기적으로 이미지를 서버로 전송
                    setInterval(() => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // 캡처된 이미지를 서버로 전송
                        canvas.toBlob(blob => {
                            const formData = new FormData();
                            formData.append('image', blob, 'frame.jpg');

                            fetch(`/upload_frame/${studentName}`, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                loadingElem.style.display = 'none';  // 로딩 메시지 숨김
                                // 서버에서 받은 결과 처리
                                const statusMessage = data.fr ? '얼굴 인식 성공' : '얼굴 인식 실패';
                                statusElem.textContent = statusMessage;
                            })
                            .catch(err => {
                                loadingElem.style.display = 'none';  // 로딩 메시지 숨김
                                console.error('Error:', err);
                                statusElem.textContent = '서버 통신 오류';
                            });
                        });
                    }, 1000); // 1초마다 이미지 전송
                })
                .catch(err => {
                    console.error('Error accessing webcam:', err);
                    statusElem.textContent = '웹캠 접근 오류';
                });
        });
    </script>
</head>
<body>
    <h1>{{ student_name }}님의 상태</h1>
    <p id="status">로딩 중...</p>
    <p id="loading" style="display:none;">처리 중...</p>  <!-- 로딩 메시지 -->
</body>
</html>
